<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Global de Terremotos </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.2.1/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #3b82f6;
            --border-radius: 20px;
            --box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .map-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        #map {
            flex: 1;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            min-height: 300px;
        }

        .legend {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            box-shadow: var(--box-shadow);
        }

        .legend h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }

        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            z-index: 1001;
        }

        .action-button {
            background-color: var(--accent-color);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-color);
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: var(--box-shadow);
        }

        .action-button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        .action-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-container">
            <header>
                <h1>Mapa Global de Terremotos</h1>
                <p>Monitoreo en vivo de los últimos terremotos y regiones en conflicto</p>
            </header>

            <div id="map"></div>

            <div class="legend">
                <h2>Leyenda</h2>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff0000;"></div>
                    <span>Terremotos recientes (últimas 6 horas)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6666;"></div>
                    <span>Terremotos de 6 a 24 horas atrás</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFFF00;"></div>
                    <span>Países en conflicto</span>
                </div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <a href="INFO.html" target="_blank">
            <button class="action-button" id="commentButton">Informacion</button>
        </a>        
        <button class="action-button" id="exportButton">Exportar Excel</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([20, 0], 2);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '©OpenStreetMap, ©CartoDB',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        var paisesEnConflicto = [
            { nombre: 'Ucrania', coords: [48.3794, 31.1656] },
            { nombre: 'Siria', coords: [34.8021, 38.9968] },
            // otros países en conflicto...
        ];

        var datosTerremotos = [];
        var conflictLayer = L.layerGroup().addTo(map);
        var earthquakeLayer = L.layerGroup().addTo(map);

        function inicializarMapaConflictos() {
            paisesEnConflicto.forEach(pais => {
                L.circle(pais.coords, {
                    radius: 300000,
                    color: '#FFFF00',
                    fillColor: '#FFFF00',
                    fillOpacity: 0.5
                }).bindPopup(`<b>${pais.nombre}</b><br><span style="color:#ff4500;">Alerta: País en conflicto actualmente.</span>`)
                .addTo(conflictLayer);
            });
        }

        inicializarMapaConflictos();

        function actualizarMapa() {
            fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson')
                .then(response => response.json())
                .then(data => {
                    earthquakeLayer.clearLayers();
                    datosTerremotos = [];

                    data.features.forEach(feature => {
                        var coords = feature.geometry.coordinates;
                        var mag = feature.properties.mag;
                        var time = new Date(feature.properties.time);

                        // Ajuste de la zona horaria a COT (UTC-5)
                        var timeCOT = new Date(time.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
                        var seisHorasAtras = new Date(Date.now() - 6 * 60 * 60 * 1000);

                        var color = time >= seisHorasAtras ? '#ff0000' : '#ff6666';

                        L.circleMarker([coords[1], coords[0]], {
                            radius: mag * 2,
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.7
                        }).bindPopup(
                            `<b>Magnitud:</b> ${mag}<br>` +
                            `<b>Ubicación:</b> ${feature.properties.place}<br>` +
                            `<b>Hora:</b> ${timeCOT.toLocaleString('es-CO')}`
                        ).addTo(earthquakeLayer);

                        datosTerremotos.push({
                            magnitud: mag,
                            ubicacion: feature.properties.place,
                            fecha: timeCOT.toLocaleString('es-CO')
                        });
                    });
                });
        }

        actualizarMapa();

        setInterval(actualizarMapa, 10 * 60 * 1000);

        document.getElementById('exportButton').addEventListener('click', generarExcel);

        async function generarExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Datos de Terremotos');

            worksheet.columns = [
                { header: 'Magnitud', key: 'magnitud', width: 15 },
                { header: 'Ubicación', key: 'ubicacion', width: 30 },
                { header: 'Fecha', key: 'fecha', width: 30 }
            ];

            worksheet.getRow(1).eachCell({ includeEmpty: true }, (cell) => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: '00FF00' }
                };
                cell.font = { color: { argb: '000000' }, bold: true };
            });

            datosTerremotos.forEach(terremoto => {
                worksheet.addRow(terremoto);
            });

            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), 'datos_terremotos.xlsx');
        }
    </script>
</body>
</html>
